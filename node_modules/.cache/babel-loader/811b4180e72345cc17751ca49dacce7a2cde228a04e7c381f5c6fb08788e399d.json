{"ast":null,"code":"var _jsxFileName = \"E:\\\\Desktop\\\\\\u684C\\u9762\\\\\\u5DE5\\u4F5C\\\\\\u7F16\\u7A0B\\\\\\u524D\\u7AEF\\\\projext\\\\project\\\\src\\\\pages\\\\main_nav_pages\\\\nav_pages\\\\drafts\\\\draftDisplay.jsx\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useState } from 'react';\nimport { getUserSurveys } from \"../../../../utils/getUserSurveys\";\nimport { RenderDraftsContext } from \"../../../../components/draftsDisplay/context/drafts\";\nimport RenderDrafts from \"../../../../components/draftsDisplay/renderDrafts\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst DraftDisplay = () => {\n  _s();\n  sessionStorage.clear();\n  // 获取用户保存在草稿的问卷\n  const [drafts, setDrafts] = useState([]);\n\n  // 是否存在草稿\n  const [hasDraft, setHasDraft] = useState(false);\n  // 将副作用移动到 useEffect 中，并在卸载时中断请求\n  useEffect(() => {\n    let mounted = true;\n    const ac = new AbortController();\n    const token = localStorage.getItem('token');\n    if (!token) {\n      setHasDraft(false);\n      return () => {};\n    }\n    fetch(`http://localhost:1337/api/clients/${token}`, {\n      signal: ac.signal\n    }).then(resp => {\n      if (!resp.ok) {\n        throw new Error(`获取用户数据失败: ${resp.status}`);\n      }\n      return resp.json();\n    }).then(data => {\n      var _data$data;\n      if (!mounted) return;\n      const noSurveys = (data === null || data === void 0 ? void 0 : (_data$data = data.data) === null || _data$data === void 0 ? void 0 : _data$data.surveys) == null || data.data.surveys.length === 0;\n      if (noSurveys) {\n        setHasDraft(false);\n        return;\n      }\n      const surveys = data.data.surveys.filter(survey => survey.published === false);\n      setHasDraft(surveys != null && surveys.length > 0);\n    }).catch(err => {\n      if ((err === null || err === void 0 ? void 0 : err.name) === 'AbortError') return; // 组件卸载，忽略\n      console.error(err);\n      if (mounted) setHasDraft(false);\n    });\n    return () => {\n      mounted = false;\n      ac.abort();\n    };\n  }, []);\n  useEffect(() => {\n    let mounted = true;\n    // 获取草稿中问卷\n    if (hasDraft) {\n      getUserSurveys(true).then(r => {\n        if (mounted) setDrafts(r);\n      }).catch(err => console.error(err));\n    } else {\n      setDrafts([]);\n    }\n    return () => {\n      mounted = false;\n    };\n  }, [hasDraft]);\n  return /*#__PURE__*/_jsxDEV(RenderDraftsContext.Provider, {\n    value: drafts,\n    children: /*#__PURE__*/_jsxDEV(RenderDrafts, {\n      hasDraft: hasDraft\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 71,\n      columnNumber: 4\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 70,\n    columnNumber: 3\n  }, this);\n};\n_s(DraftDisplay, \"5EfIOBqSS+M0BGV8925jyvWtV/g=\");\n_c = DraftDisplay;\nexport default DraftDisplay;\nvar _c;\n$RefreshReg$(_c, \"DraftDisplay\");","map":{"version":3,"names":["React","useEffect","useState","getUserSurveys","RenderDraftsContext","RenderDrafts","jsxDEV","_jsxDEV","DraftDisplay","_s","sessionStorage","clear","drafts","setDrafts","hasDraft","setHasDraft","mounted","ac","AbortController","token","localStorage","getItem","fetch","signal","then","resp","ok","Error","status","json","data","_data$data","noSurveys","surveys","length","filter","survey","published","catch","err","name","console","error","abort","r","Provider","value","children","fileName","_jsxFileName","lineNumber","columnNumber","_c","$RefreshReg$"],"sources":["E:/Desktop/桌面/工作/编程/前端/projext/project/src/pages/main_nav_pages/nav_pages/drafts/draftDisplay.jsx"],"sourcesContent":["import React, {useEffect, useState} from 'react';\r\nimport {getUserSurveys} from \"../../../../utils/getUserSurveys\";\r\nimport {RenderDraftsContext} from \"../../../../components/draftsDisplay/context/drafts\";\r\nimport RenderDrafts from \"../../../../components/draftsDisplay/renderDrafts\";\r\n\r\nconst DraftDisplay = () => {\r\n\tsessionStorage.clear();\r\n\t// 获取用户保存在草稿的问卷\r\n\tconst [drafts, setDrafts] = useState([]);\r\n\r\n\r\n\t// 是否存在草稿\r\n\tconst [hasDraft, setHasDraft] = useState(false);\r\n\t// 将副作用移动到 useEffect 中，并在卸载时中断请求\r\n\tuseEffect(() => {\r\n\t\tlet mounted = true;\r\n\t\tconst ac = new AbortController();\r\n\t\tconst token = localStorage.getItem('token');\r\n\r\n\t\tif (!token) {\r\n\t\t\tsetHasDraft(false);\r\n\t\t\treturn () => {};\r\n\t\t}\r\n\r\n\t\tfetch(`http://localhost:1337/api/clients/${token}`, { signal: ac.signal })\r\n\t\t\t.then(resp => {\r\n\t\t\t\tif (!resp.ok) {\r\n\t\t\t\t\tthrow new Error(`获取用户数据失败: ${resp.status}`);\r\n\t\t\t\t}\r\n\t\t\t\treturn resp.json();\r\n\t\t\t})\r\n\t\t\t.then(data => {\r\n\t\t\t\tif (!mounted) return;\r\n\t\t\t\tconst noSurveys = data?.data?.surveys == null || data.data.surveys.length === 0;\r\n\t\t\t\tif (noSurveys) {\r\n\t\t\t\t\tsetHasDraft(false);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tconst surveys = data.data.surveys.filter(survey => survey.published === false);\r\n\t\t\t\tsetHasDraft(surveys != null && surveys.length > 0);\r\n\t\t\t})\r\n\t\t\t.catch(err => {\r\n\t\t\t\tif (err?.name === 'AbortError') return; // 组件卸载，忽略\r\n\t\t\t\tconsole.error(err);\r\n\t\t\t\tif (mounted) setHasDraft(false);\r\n\t\t\t});\r\n\r\n\t\treturn () => {\r\n\t\t\tmounted = false;\r\n\t\t\tac.abort();\r\n\t\t};\r\n\t}, []);\r\n\r\n\r\n\t\tuseEffect(() => {\r\n\t\t\tlet mounted = true;\r\n\t\t\t// 获取草稿中问卷\r\n\t\t\tif (hasDraft) {\r\n\t\t\t\tgetUserSurveys(true).then(r => {\r\n\t\t\t\t\tif (mounted) setDrafts(r);\r\n\t\t\t\t}).catch(err => console.error(err));\r\n\t\t\t} else {\r\n\t\t\t\tsetDrafts([]);\r\n\t\t\t}\r\n\t\t\treturn () => { mounted = false; };\r\n\t\t}, [hasDraft]);\r\n\r\n\r\n\treturn (\r\n\t\t<RenderDraftsContext.Provider value={drafts}>\r\n\t\t\t<RenderDrafts hasDraft={hasDraft}/>\r\n\t\t</RenderDraftsContext.Provider>\r\n\t);\r\n};\r\n\r\nexport default DraftDisplay;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}